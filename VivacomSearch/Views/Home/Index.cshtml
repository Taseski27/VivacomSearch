@model List<API.Entities.Folder>
@{
    ViewBag.Title = "Search";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container" style="margin-top:50px;">
    <label>Choose Folder</label>
    <br />
    @Html.DropDownList("Directory", new SelectList(Model, "Path", "Name"))
    <br />
    <br />
    <label>Enter keyword to search</label>
    <br />
    <input type="text" id="keyword" />
    <input type="button" id="sendKeyword" value="Search" />
    <div id="searchResults"></div>
</div>
@section scripts {
    <script src="~/Scripts/jquery.signalR-2.2.3.min.js"></script>
    <script src="~/signalr/hubs"></script>
    <script>
        $(function () {
            var Search = $.connection.searchHub;

            Search.client.addNewMessageToPage = function (folder) {
                // Add the link to the results
                folder.Files.forEach(function (file) {
                    file.Matches.forEach(function (match) {
                        $('#searchResults').append('<a href="/viva/Results/GetPid?path=' + folder.Name + '\' + ' + file.Name + 'log&row=' + match.PositionY + '&col=' + match.PositionX + '" onclick="PostCoordinates(event,' + match.PositionY + ',' + match.PositionX + ')">' +
                            folder.Name + '\' + ' + file.Name +
                            '</a >');
                    });
                });
            }

            $('#keyword').focus();

            $.connection.hub.start().done(function () {
                $('#sendKeyword').click(function () {
                    $('#searchResults').empty();
                    Search.server.search($('#keyword').val(), $('#Directory').find(":selected").val(), $('#Directory').find(":selected").text());
                });
            });
        });

        function PostCoordinates(e, row, col) {
            e.preventDefault();

            var match;
            match.PositionX = col;
            match.PositionY = row;

            $.ajax({
                contentType: 'application/json',
                data: JSON.stringify(match),
                type: 'POST',
                url: '@Url.Action("GetWholeSection", "Home")'
            }).done(function (data) {
                $('#searchResults').html(data);
            });
        }
    </script>
}

